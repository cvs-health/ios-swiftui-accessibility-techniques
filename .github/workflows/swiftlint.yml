name: Accessibility Checks
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  swiftlint:
    name: SwiftLint A11y Rules
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for comparison
      
      - name: Cache SwiftLint
        uses: actions/cache@v3
        with:
          path: /usr/local/bin/swiftlint
          key: swiftlint-${{ runner.os }}
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Get changed Swift files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.swift
      
      - name: Run SwiftLint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running SwiftLint on changed files..."
          echo "${{ steps.changed-files.outputs.all_changed_files }}" | xargs swiftlint lint --strict --reporter github-actions-logging
            
      - name: No files to check
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "No Swift files changed in this PR"

  accessibility-audit:
    name: Custom A11y Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed Swift files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.swift
      
      - name: Check for accessibility issues
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking accessibility patterns in changed files..."
          
          EXIT_CODE=0
          
          # Check each changed Swift file
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking: $file"
            
            # Check for Images without labels (excluding known valid patterns)
            if grep -n "Image(" "$file" | grep -v "accessibilityLabel" | grep -v "accessibilityHidden" | grep -v "combine" | grep -v "swiftlint:disable"; then
              echo "::error file=$file::Found Image without accessibility label"
              EXIT_CODE=1
            fi
            
            # Check for Buttons without text or labels
            if grep -n "Button {" "$file" | grep -v "accessibilityLabel" | grep -v '"' | grep -v "Text(" | grep -v "swiftlint:disable"; then
              echo "::warning file=$file::Found Button that may be missing accessibility label"
            fi
            
            # Check for empty Text views
            if grep -n 'Text("")' "$file"; then
              echo "::error file=$file::Found empty Text() view - bad for accessibility"
              EXIT_CODE=1
            fi
            
            # Check for tap gestures without labels
            if grep -n "onTapGesture" "$file" | grep -v "accessibilityLabel" | grep -v "accessibilityAction" | grep -v "swiftlint:disable"; then
              echo "::warning file=$file::Found onTapGesture without accessibility label or action"
            fi
            
            # Check for generic labels
            if grep -n 'accessibilityLabel("Button")\|accessibilityLabel("Image")\|accessibilityLabel("Icon")' "$file"; then
              echo "::warning file=$file::Found generic accessibility label - be more descriptive"
            fi
          done
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Accessibility issues found!"
            exit $EXIT_CODE
          else
            echo "‚úÖ No accessibility issues found"
          fi

  accessibility-report:
    name: Generate A11y Report
    runs-on: ubuntu-latest
    if: always()
    needs: [swiftlint, accessibility-audit]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate Accessibility Summary
        run: |
          echo "# Accessibility Check Summary üîç" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SwiftLint accessibility rules" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Image accessibility labels" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Button accessibility labels" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Empty text views" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tap gesture accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Generic label detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- [Apple Accessibility Guidelines](https://developer.apple.com/accessibility/)" >> $GITHUB_STEP_SUMMARY
          echo "- [SwiftUI Accessibility](https://developer.apple.com/documentation/swiftui/view-accessibility)" >> $GITHUB_STEP_SUMMARY

  block-merge:
    name: Block Merge on Failures
    runs-on: ubuntu-latest
    needs: [swiftlint, accessibility-audit]
    if: failure()
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Accessibility checks failed**\n\nPlease review the accessibility issues found in the checks above before merging.\n\n**Common fixes:**\n- Add `.accessibilityLabel("description")` to images\n- Add `.accessibilityHidden(true)` for decorative images\n- Ensure buttons have descriptive labels\n- Use `.accessibilityElement(children: .combine)` for complex views\n\n**Need to suppress a warning?**\n```swift\n// swiftlint:disable:next a11y_swiftui_image_missing_label\nImage(systemName: "icon")\n```'
            })
